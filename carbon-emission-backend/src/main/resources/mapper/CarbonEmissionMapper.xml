<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bjfu.carbon.mapper.CarbonEmissionMapper">

    <resultMap id="BaseResultMap" type="com.bjfu.carbon.domain.CarbonEmission">
            <id property="id" column="id" jdbcType="BIGINT"/>
            <result property="name" column="name" jdbcType="VARCHAR"/>
            <result property="category" column="category" jdbcType="VARCHAR"/>
            <result property="consumption" column="consumption" jdbcType="DECIMAL"/>
            <result property="purpose" column="purpose" jdbcType="VARCHAR"/>
            <result property="year" column="year" jdbcType="INTEGER"/>
            <result property="month" column="month" jdbcType="INTEGER"/>
            <result property="amount" column="amount" jdbcType="DECIMAL"/>
            <result property="place" column="place" jdbcType="VARCHAR"/>
            <result property="emissionType" column="emission_type" jdbcType="INTEGER"/>
            <result property="createdTime" column="created_time" jdbcType="TIMESTAMP"/>
            <result property="modifiedTime" column="modified_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,name,category,consumption,purpose,
        year,month,amount,place,emission_type,created_time,modified_time
    </sql>
    
    <!-- 可复用的SQL片段：碳排放基础查询（包含JOIN和年份过滤） -->
    <sql id="emission_base_query">
        FROM sys_carbon.carbon_emission ce
        LEFT JOIN sys_carbon.exchange_setting es ON ce.category = es.object_category
        WHERE ce.year = #{year}
    </sql>
    
    <!-- 可复用的SQL片段：排放量计算公式（不包含别名，使用时自行添加） -->
    <sql id="emission_calculation">
        SUM(ce.consumption * es.exchange_coefficient)
    </sql>
    
    <!-- 可复用的SQL片段：按分类和排放类型分组的CTE -->
    <sql id="emission_by_category_type_cte">
        emission_by_category_type AS (
            -- 按分类和排放类型分组，计算总消耗量和排放量
            SELECT ce.category,
                   SUM(ce.consumption) AS object_consumption,
                   ROUND(SUM(ce.consumption) * es.exchange_coefficient, 2) AS emissionAmount,
                   ce.emission_type,
                   es.unit
            <include refid="emission_base_query"/>
            GROUP BY ce.category, ce.emission_type, es.unit, es.exchange_coefficient
        )
    </sql>
    
    <!-- 可复用的SQL片段：按分类和月份分组的CTE -->
    <sql id="emission_by_category_month_cte">
        emission_by_category_month AS (
            -- 按分类和月份分组，计算每个分类每个月的排放量
            SELECT ce.category,
                   ce.month,
                   <include refid="emission_calculation"/> AS emissionAmount
            <include refid="emission_base_query"/>
            GROUP BY ce.category, ce.month, es.exchange_coefficient
        )
    </sql>
    
    <!-- 可复用的SQL片段：最大排放量CTE -->
    <sql id="max_emission_cte">
        max_emission AS (
            -- 找到最大排放量的分类和月份
            SELECT category, month, ROUND(emissionAmount, 2) AS emiMaxNumber
            FROM emission_by_category_month
            ORDER BY emissionAmount DESC
            LIMIT 1
        )
    </sql>
    
    <!-- 可复用的SQL片段：最小排放量CTE -->
    <sql id="min_emission_cte">
        min_emission AS (
            -- 找到最小排放量的分类和月份
            SELECT category, month, ROUND(emissionAmount, 2) AS emiMinNumber
            FROM emission_by_category_month
            ORDER BY emissionAmount ASC
            LIMIT 1
        )
    </sql>
    
    <select id="pageByObjectName" resultType="com.bjfu.carbon.domain.CarbonEmission">
        select * from carbon_emission as ce
        <where>
            <if test="name != null and name != '' ">
                <bind name="namePattern" value="'%' + name + '%'"/>
                and ce.name like #{namePattern}
            </if>
            <if test="year != null and year != '' ">
                and ce.year = #{year}
            </if>
            <if test="month != null and month != '' ">
                and ce.month = #{month}
            </if>
        </where>
        limit #{begin} , #{pageSize}
    </select>
    
    <select id="selectTotalCount" resultType="java.lang.Integer">
        select count(*)
        from carbon_emission as ce
        <where>
            <if test="name != null and name != '' ">
                <bind name="namePattern" value="'%' + name + '%'"/>
                and ce.name like #{namePattern}
            </if>
            <if test="year != null and year != '' ">
                and ce.year = #{year}
            </if>
            <if test="month != null and month != '' ">
                and ce.month = #{month}
            </if>
        </where>
    </select>
    
    <select id="selectEmiAndConsume" resultType="com.bjfu.carbon.domain.EmissionAndConsume">
        WITH 
        <include refid="emission_by_category_type_cte"/>,
        <include refid="emission_by_category_month_cte"/>,
        <include refid="max_emission_cte"/>,
        <include refid="min_emission_cte"/>
        SELECT t1.category AS object_category,
               t1.object_consumption,
               t1.emissionAmount,
               t1.emission_type,
               t1.unit,
               t2.category AS object_category_max,
               t2.month AS emission_month_max,
               t2.emiMaxNumber,
               t3.category AS object_category_min,
               t3.month AS emission_month_min,
               t3.emiMinNumber
        FROM emission_by_category_type t1
        CROSS JOIN (SELECT * FROM max_emission LIMIT 1) t2
        CROSS JOIN (SELECT * FROM min_emission LIMIT 1) t3;
    </select>
    
    <select id="selectEmissionType" resultType="com.bjfu.carbon.domain.CarbonEmission">
        SELECT ce.category, 
               ROUND(<include refid="emission_calculation"/>, 2) AS amount, 
               ce.emission_type, 
               ce.month
        <include refid="emission_base_query"/>
        GROUP BY ce.month, ce.category, ce.emission_type, es.exchange_coefficient;
    </select>
    
    <select id="selectYearsWithData" resultType="java.lang.Integer">
        SELECT DISTINCT ce.year
        FROM carbon_emission ce
        WHERE ce.year BETWEEN #{startYear} AND #{endYear}
        ORDER BY ce.year DESC
    </select>
    
    <select id="selectTotalEmission" resultType="java.lang.Double">
        SELECT ROUND(SUM(ce.consumption * es.exchange_coefficient), 2)
        <include refid="emission_base_query"/>
        <if test="month != null">
            AND ce.month = #{month}
        </if>
    </select>
</mapper>