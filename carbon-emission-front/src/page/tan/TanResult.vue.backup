<template>
  <div class="tanResult">
    <div class="chooseBtn">
      <div class="flex-box-headerr">
        <el-form>
          <el-tag>选择年份：</el-tag>
          <el-form-item style="display: inline-block;margin-bottom: 5px !important;">
            <el-date-picker style="width: 200px;" class="buildingleft" v-model="showYear" type="year" value-format='yyyy'
              placeholder="选择年" size="small">
            </el-date-picker>
            <el-select v-model="showMonth" placeholder="选择月">
              <el-option v-for="item in 12" :key="item" :label="item" :value="item">
              </el-option>
            </el-select>
            <!-- <el-input style="width: 200px;" class="buildingright" v-model="showMonth" placeholder="选择月份"
              size="small"></el-input> -->
          </el-form-item>
          <el-button class="form-item-inline" size="small" @click="refreshCharts()" plain
            icon="el-icon-search">查询</el-button>
        </el-form>
      </div>
    </div>

    <!-- 使用标签页组织图表 -->
    <div class="result-tabs">
      <el-tabs v-model="activeTab" @tab-click="handleTabClick">
        <!-- Tab 1: 总体概览 -->
        <el-tab-pane label="总体概览" name="overview">
          <div class="tab-content">
            <div class="overview-grid">
              <div class="junzhi">
                <div class="forest-card" style="width:100%;height:350px;">
                  <div class="forest-card-header">
                    <i class="el-icon-menu"></i>
                    <span>{{ this.year }}年{{ this.month }}月CO<sub>2</sub>总体排放量情况</span>
                  </div>
                  <div style="margin: 20px auto; width: calc(100% - 40px); display: flex; justify-content: center;">
                    <table style="width: 100%; max-width: 320px; height: 200px;" class="table_two forest-table" border="1px">
                      <thead height="50px" style="text-align: center;">
                        <th style="width: 40%;">指标</th>
                        <th style="width: 60%;">CO<sub>2</sub>排放量（kg）</th>
                      </thead>
                      <tbody style="text-align: center;">
                        <tr>
                          <td style="background-color: #f0f7ed;font-weight: 600;">总量</td>
                          <td>{{ parseFloat(carbonInformation.totalEmission).toFixed(2) }}</td>
                        </tr>
                        <tr>
                          <td style="background-color: #f0f7ed;font-weight: 600;">人均</td>
                          <td>{{ parseFloat(carbonInformation.personAverageEmission).toFixed(2) }}</td>
                        </tr>
                        <tr>
                          <td style="background-color: #f0f7ed;font-weight: 600;">地均</td>
                          <td>{{ parseFloat(carbonInformation.groundAverageEmission).toFixed(2) }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="zhuzhuangtu forest-card" style="height:350px;">
                <div class="forest-card-header">
                  <i class="el-icon-s-data"></i>
                  <span>{{ this.year }}年{{ this.month }}月各排放源CO<sub>2</sub>排放量</span>
                </div>
                <div id="myChart4" style="width:100%;height:300px;margin-top: 5px">
                </div>
              </div>
            </div>
          </div>
        </el-tab-pane>

        <!-- Tab 2: 构成分析 -->
        <el-tab-pane label="构成分析" name="composition">
          <div class="tab-content">
            <div class="composition-grid">
              <div class="sangshen forest-card">
                <div class="forest-card-header">
                  <i class="el-icon-s-data"></i>
                  <span>{{ this.year }}年{{ this.month }}月CO<sub>2</sub>排放流动情况</span>
                </div>
                <div id="myMulberry" style="text-align: center;padding-left: 1%; width: 100%;height: 450px;margin-top: 10px">
                </div>
              </div>
              <div class="bingtu forest-card">
                <div class="forest-card-header">
                  <i class="el-icon-s-data"></i>
                  <span>{{ this.year }}年{{ this.month }}月CO<sub>2</sub>排放构成</span>
                </div>
                <div id="myChart1" style="text-align: center;width:100%;height:400px;margin-top: 10px;margin-bottom: 10px;">
                </div>
              </div>
            </div>
          </div>
        </el-tab-pane>

        <!-- Tab 3: 趋势对比 -->
        <el-tab-pane label="趋势对比" name="trend">
          <div class="tab-content">
            <div class="duijizhu forest-card">
              <div class="forest-card-header">
                <i class="el-icon-s-data"></i>
                <span>{{ this.duijizhu.startYear }}年{{ this.duijizhu.startMonth }}月&nbsp;&nbsp;~&nbsp;&nbsp;{{ this.duijizhu.endYear }}年{{ this.duijizhu.endMonth }}月CO<sub>2</sub>排放趋势</span>
              </div>
              <div class="trend-controls">
                <el-form :inline="true" class="filter-form">
                  <el-form-item>
                    <el-tag>起始时间：</el-tag>
                    <el-date-picker style="width: 100px;" v-model="duijizhu.showStartYear" type="year"
                      value-format='yyyy' placeholder="选择年" size="small">
                    </el-date-picker>
                    <el-select v-model="duijizhu.showStartMonth" placeholder="选择月" style="width: 80px;" @change="changeMe()">
                      <el-option v-for="item in 12" :key="item" :label="item" :value="item">
                      </el-option>
                    </el-select>
                  </el-form-item>
                  <el-form-item>
                    <el-tag>结束时间：</el-tag>
                    <el-date-picker style="width: 100px;" v-model="duijizhu.showEndYear" type="year"
                      value-format='yyyy' placeholder="选择年" size="small">
                    </el-date-picker>
                    <el-select v-model="duijizhu.showEndMonth" placeholder="选择月" style="width: 80px;" @change="changeMe()">
                      <el-option v-for="item in mse.slice(ms - 2)" :key="item" :label="item" :value="item">
                      </el-option>
                    </el-select>
                  </el-form-item>
                  <el-form-item>
                    <el-button class="info" size="small" @click="searchType = 0" plain>物品类别</el-button>
                    <el-button class="info" size="small" @click="searchType = 1" plain>排放类型</el-button>
                    <el-button class="forest-btn" size="small" @click="getConditionalDuijizhu()" plain
                      icon="el-icon-search" style="margin-left: 10px;">查询</el-button>
                  </el-form-item>
                </el-form>
              </div>
              <div id="myduijiBar" style="width:100%;height:500px;margin-top: 20px;">
              </div>
            </div>
          </div>
        </el-tab-pane>
      </el-tabs>
    </div>
</template>
<script>
import * as echarts from 'echarts/core';
import { SankeyChart } from 'echarts/charts';
import { CanvasRenderer } from 'echarts/renderers';

echarts.use([SankeyChart, CanvasRenderer]);
import MyPie from "../../components/Assessment";
import TanHeader from "../../components/TanHeader";
import {
  getJunzhi,
  getCarbonMulberry,
  getDuijizhuCategory,
  getDuijizhuType,
  getBingtu,
} from "../../api/user";
import axios from "axios";
import { publicNetworkIpAndPort } from "../../api/globalVar";
export default {
  components: { TanHeader, MyPie },
  name: "",
  data() {
    return {
      activeTab: 'overview', // 默认激活的标签页
      ms: 1,
      mse: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
      carbonInformation: {//均值表格
        totalEmission: '',
        personAverageEmission: '',
        groundAverageEmission: '',
      },
      showYear: '',
      showMonth: '',
      year: '',
      searchType: '',//选择查询类型
      sangShen: {
        data: [],//桑基图节点数据列表
        links: [],//节点间的边。注意: 桑基图理论上只支持有向无环图
      },
      duijizhu: {
        showStartYear: '',
        showStartMonth: '',
        showEndYear: '',
        showEndMonth: '',
        startYear: '2023',
        startMonth: '1',
        endYear: '2023',
        endMonth: '6',
        xArr: [],
        series: [],
      },
      month: '',
      carbonInfor: {},
      myLine: '',
      emissionInformationIn: {
        year: '',
      },
      autoLoadDuijizhu: false, // 标记是否已经自动加载了区间图
      myChart1: '',
      xxValue: '',
      yyValue: '',
      xValue: '',
      yValue: '',
    }
  },
  mounted: function () {
    // 初始调用时不传year和month，让后端自动回退查找
    this.year = '';
    this.month = '';
    this.autoLoadDuijizhu = false;
    // 先通过getJunzhiTable获取统一的年份，然后使用这个年份统一请求所有图表
    this.getJunzhiTable().then(() => {
      // 获取到年份后，使用统一的年份请求其他图表
      if (this.year && this.year !== '') {
        // 使用统一的年份请求所有图表
        this.getMulberry();
        this.getEmissionZhu();
        this.getEmissionBing();
        // 自动加载区间图：设置为该年份的1月至12月
        this.autoLoadDuijizhuForYear(this.year);
      } else {
        // 如果所有数据都为空，显示当前年份1月至12月
        const currentYear = new Date().getFullYear();
        this.year = currentYear;
        this.getMulberry();
        this.getEmissionZhu();
        this.getEmissionBing();
        this.autoLoadDuijizhuForYear(currentYear);
      }
    }).catch(() => {
      // 如果请求失败，使用当前年份
      const currentYear = new Date().getFullYear();
      this.year = currentYear;
      this.getMulberry();
      this.getEmissionZhu();
      this.getEmissionBing();
      this.autoLoadDuijizhuForYear(currentYear);
    });
  },
  methods: {
    changeMe() {
      console.log("this.duijizhu.showStartMonth:", this.duijizhu.showStartMonth);
      this.ms = parseInt(this.duijizhu.showStartMonth) + 1;
      console.log("ms:", this.ms);
    },
    handleTabClick(tab) {
      // 标签页切换时的处理逻辑
      console.log('切换到标签页:', tab.name);
      // 可以在这里添加特定标签页的数据加载逻辑
      if (tab.name === 'trend') {
        // 当切换到趋势对比标签页时，确保数据已加载
        this.$nextTick(() => {
          // 重新渲染趋势图表
          if (this.duijizhu.xArr.length > 0) {
            this.getConditionalDuijizhu();
          }
        });
      }
    },
    //柱状图
    getEmissionZhu() {
      // 如果year和month为空，不传参数，让后端自动回退查找
      const params = {};
      if (this.year && this.year !== '') {
        params.year = this.year;
      }
      if (this.month && this.month !== '') {
        params.month = this.month;
      }
      getBingtu(params).then((res) => {
        if (res.data.code == 200) {
          // 如果后端返回了actualYear，更新显示的年份
          if (res.data.data.actualYear) {
            this.year = res.data.data.actualYear;
            // 自动加载区间图：设置为该年份的1月至12月
            this.autoLoadDuijizhuForYear(res.data.data.actualYear);
          }
          // 处理返回的数据（可能是list字段或直接是数组）
          var dataList = res.data.data.list || res.data.data;
          // console.log(res.data)
          // console.log(dataList.length)
          var xValueTemp = [];
          var yValueTemp = [];
          for (var i = 0; i < dataList.length; i++) {
            xValueTemp.push(dataList[i].objectCategory);
            yValueTemp.push(dataList[i].emissionAmount);
          }
          this.xxValue = xValueTemp;
          this.yyValue = yValueTemp;
          //this.$refs.voteGraph.drawLine(xValueTemp, yValueTemp);
          // console.log(this.xxValue)
          // console.log(this.yyValue)
          this.myChart4 = this.$echarts.init(document.getElementById('myChart4'))
          this.myChart4.clear()
          this.myChart4.setOption({
            tooltip: {
              trigger: 'item',
              formatter: (params) => {
                // console.log(params);
                return '碳排放量' + '<br/>' + params.marker + params.name + ':' + parseFloat(params.value).toFixed(2) + '(kg)' + '<br/>';
              },
            },
            legend: {
              orient: 'vertical',
              x: 'right',
              y: 'top',
              data: ['CO₂排放量(kg)']
            },
            grid: {
              left: '12%',
              right: '15%',
              bottom: '20%',
              top: '8%',
              containLabel: false
            },
            xAxis: {
              data: this.xxValue,
              axisLabel: {
                interval: 0,
                rotate: 0,
                margin: 8,
                textStyle: {
                  fontSize: 11
                },
                formatter: function(value) {
                  // 如果文字太长，截断并显示省略号
                  if (value.length > 8) {
                    return value.substring(0, 8) + '...';
                  }
                  return value;
                }
              },
            },
            yAxis: {
              axisLabel: {
                textStyle: {
                  fontSize: 11
                }
              }
            },
            series: [{
              name: 'CO₂排放量(kg)',
              type: 'bar',
              data: this.yyValue,
              itemStyle: {
                emphasis: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                color: function () {
                  // 自定义颜色
                  // var colorList = ['#1ab394', '#FB4A55', 'cadetblue','#E6A23C','#409EFF','cadetblue','#409EFF','#E6A23C']
                  // return colorList[params.dataIndex]
                  return "#" + Math.floor(Math.random() * 16777215).toString(16);
                }
              }
            }]
          }, true)
        }
      }).catch(() => {
      }).finally(() => {
      });

    },
    //饼图
    getEmissionBing() {
      // 如果year和month为空，不传参数，让后端自动回退查找
      const params = {};
      if (this.year && this.year !== '') {
        params.year = this.year;
      }
      if (this.month && this.month !== '') {
        params.month = this.month;
      }
      getBingtu(params).then((res) => {
        if (res.data.code == 200) {
          // 如果后端返回了actualYear，且当前year为空，则更新显示的年份（保持统一）
          // 注意：在mounted时，year已经通过getJunzhiTable统一设置了，这里主要用于用户手动查询时
          if (res.data.data.actualYear && (!this.year || this.year === '')) {
            this.year = res.data.data.actualYear;
            // 自动加载区间图：设置为该年份的1月至12月
            this.autoLoadDuijizhuForYear(res.data.data.actualYear);
          }
          // 处理返回的数据（可能是list字段或直接是数组）
          var dataList = res.data.data.list || res.data.data;
          // console.log(res.data)
          // console.log(dataList.length)
          var xValueTemp = [];
          var yValueTemp = [];
          for (var i = 0; i < dataList.length; i++) {
            xValueTemp.push(dataList[i].objectCategory);
            yValueTemp.push({
              name: dataList[i].objectCategory,
              value: dataList[i].emissionAmount
            });
          }
          // this.xValue = xValueTemp;
          // this.yValue = yValueTemp;
          //this.$refs.voteGraph.drawLine(xValueTemp, yValueTemp);
          // console.log(this.xValue)
          // console.log(this.yValue)
          this.myChart1 = this.$echarts.init(document.getElementById('myChart1'))
          this.myChart1.clear()
          this.myChart1.setOption({
            title: {
              text: ''
            },
            tooltip: {
              trigger: 'item',
              formatter: (params) => {
                // console.log(params);
                return '碳排放量' + '<br/>' + params.marker + params.name + ':' + parseFloat(params.value).toFixed(2) + '(kg)' + '<br/>';
              },
              show: true,
            },
            legend: {
              type: 'scroll',
              orient: 'vertical',
              right: 10,
              top: 75,
              bottom: 20,
              data: xValueTemp
            },
            xAxis: {
              type: "category",
              show: false,
            },
            yAxis: {
              type: "value",
            },
            series: [{
              name: '碳排放量占比',
              type: 'pie',
              radius: '75%',
              center: ['43%', '57%'],
              barWidth: '10%',
              data: yValueTemp,
              label: {
                show: true,
                position: 'outside',
                formatter: `{d}%`
              }
            }]
          }, true)
        }
      }).catch(() => {
      }).finally(() => {
      });

    },
    //返回指定年月中包含的年月数
    calculateMonths(startYear, startMonth, endYear, endMonth) {
      const result = []; this.year
      // console.log("startYear", startYear, "  endYear", endYear, "  startMonth", startMonth, "  endMonth", endMonth)
      // 计算总共的月份数
      const totalMonths = (Number(endYear) - Number(startYear)) * 12 + (Number(endMonth) - Number(startMonth)) + 1;

      // 逐个生成年月字符串
      for (let i = 0; i < totalMonths; i++) {
        const currentYear = Number(startYear) + Math.floor((Number(startMonth) + i - 1) / 12);
        const currentMonth = ((Number(startMonth) + i - 1) % 12) + 1;
        const monthString = `${currentYear}年${currentMonth}月`;
        result.push(monthString);
      }
      return result;
    },
    refreshCharts() {
      // 用户手动查询时，重置自动加载标志
      this.autoLoadDuijizhu = false;
      // 用户选择时，使用用户选择的年月
      if ((this.showYear == null || this.showYear == '') && (this.showMonth == null || this.showMonth == '')) {
        // 用户没有选择，清空year和month，先通过getJunzhiTable获取统一年份
        this.year = '';
        this.month = '';
        this.getJunzhiTable().then(() => {
          // 获取到统一年份后，使用这个年份请求所有图表
          if (this.year && this.year !== '') {
            this.getMulberry();
            this.getEmissionBing();
            this.getEmissionZhu();
            this.autoLoadDuijizhuForYear(this.year);
          } else {
            // 所有数据都为空，显示当前年份1月至12月
            const currentYear = new Date().getFullYear();
            this.year = currentYear;
            this.getMulberry();
            this.getEmissionBing();
            this.getEmissionZhu();
            this.autoLoadDuijizhuForYear(currentYear);
          }
        }).catch(() => {
          // 如果请求失败，使用当前年份
          const currentYear = new Date().getFullYear();
          this.year = currentYear;
          this.getMulberry();
          this.getEmissionBing();
          this.getEmissionZhu();
          this.autoLoadDuijizhuForYear(currentYear);
        });
      }
      else if (((this.showYear == '' || this.showYear == null) && (this.showMonth != '' && this.showMonth != null))
        || ((this.showMonth != '' && this.showMonth != null) && (Number(this.showMonth) <= 0 || Number(this.showMonth) > 12))) {
        this.$message.error('请输入完整且合理的查询年月！');
        this.year = '';
        this.month = '';
        this.showYear = '';
        this.showMonth = '';
      }
      else {
        // 用户选择了年月，使用用户选择的年月（统一使用这个年份）
        this.year = this.showYear;
        this.month = this.showMonth;
        this.getJunzhiTable();
        this.getMulberry();
        this.getEmissionBing();
        this.getEmissionZhu();
        // 用户选择时，自动加载该年份的1月至12月区间图
        if (this.year && this.year !== '') {
          this.autoLoadDuijizhuForYear(this.year);
        }
      }
    },
    //均值表格
    getJunzhiTable() {
      // 如果year和month为空，不传参数，让后端自动回退查找
      const params = {};
      if (this.year && this.year !== '') {
        params.year = this.year;
      }
      if (this.month && this.month !== '') {
        params.month = this.month;
      }
      return getJunzhi(params).then(res => {
        if (res.data.code == 200) {
          this.carbonInformation.totalEmission = res.data.data.totalEmission;
          this.carbonInformation.personAverageEmission = res.data.data.personAverageEmission
          this.carbonInformation.groundAverageEmission = res.data.data.groundAverageEmission
          // 如果后端返回了actualYear，更新显示的年份（统一使用这个年份）
          if (res.data.data.actualYear) {
            this.year = res.data.data.actualYear;
          } else {
            // 如果没有返回actualYear，使用当前年份
            this.year = new Date().getFullYear();
          }
        } else {
          // 如果请求失败，使用当前年份
          this.year = new Date().getFullYear();
        }
      }).catch(() => {
        // 如果请求失败，使用当前年份
        this.year = new Date().getFullYear();
      });
    },
    // 自动加载区间图数据
    autoLoadDuijizhuForYear(year) {
      if (!this.autoLoadDuijizhu && year) {
        this.autoLoadDuijizhu = true;
        this.duijizhu.startYear = year.toString();
        this.duijizhu.startMonth = '1';
        this.duijizhu.endYear = year.toString();
        this.duijizhu.endMonth = '12';
        this.duijizhu.xArr = this.calculateMonths(this.duijizhu.startYear, this.duijizhu.startMonth, this.duijizhu.endYear, this.duijizhu.endMonth);
        this.getCarbonBarDuiji();
      }
    },
    //条件柱状堆积图
    getConditionalDuijizhu() {
      if (this.duijizhu.showStartYear == '' && this.duijizhu.showStartMonth == '' && this.duijizhu.showEndYear == '' && this.duijizhu.showEndMonth == '') {
        this.getCarbonBarDuiji();
      }
      else if (!(this.duijizhu.showStartYear != '' && this.duijizhu.showStartYear != null && this.duijizhu.showStartMonth != '' && this.duijizhu.showStartMonth != null
        && this.duijizhu.showEndYear != '' && this.duijizhu.showEndYear != null && this.duijizhu.showEndMonth != '' && this.duijizhu.showEndMonth != null
        && Number(this.duijizhu.showStartMonth) >= 1 && Number(this.duijizhu.showStartMonth) <= 12 && Number(this.duijizhu.showEndMonth) >= 1
        && Number(this.duijizhu.showEndMonth) <= 12 && Number(this.duijizhu.showStartYear) * 12 + Number(this.duijizhu.showStartMonth) <= Number(this.duijizhu.showEndYear) * 12 + Number(this.duijizhu.showEndMonth))) {
        this.$message.error('请输入完整且合理的查询起始年月！');
        this.duijizhu.showStartYear = '';
        this.duijizhu.showStartMonth = '';
        this.duijizhu.showEndYear = '';
        this.duijizhu.showEndMonth = '';
        this.duijizhu.startYear = '2023';
        this.duijizhu.startMonth = '1';
        this.duijizhu.endYear = '2023';
        this.duijizhu.endMonth = '6';
      } else {
        this.duijizhu.startYear = this.duijizhu.showStartYear;
        this.duijizhu.startMonth = this.duijizhu.showStartMonth;
        this.duijizhu.endYear = this.duijizhu.showEndYear;
        this.duijizhu.endMonth = this.duijizhu.showEndMonth;
        this.duijizhu.xArr = this.calculateMonths(this.duijizhu.startYear, this.duijizhu.startMonth, this.duijizhu.endYear, this.duijizhu.endMonth)
        this.getCarbonBarDuiji();
      }
    },
    //堆叠柱状图
    async getCarbonBarDuiji() {
      this.duijizhu.series = []
      // 如果startYear和endYear都为空，不设置xArr，让图表显示为空
      if (this.duijizhu.startYear != '' && this.duijizhu.startYear != null && this.duijizhu.startMonth != '' && this.duijizhu.startMonth != null
        && this.duijizhu.endYear != '' && this.duijizhu.endYear != null && this.duijizhu.endMonth != '' && this.duijizhu.endMonth != null
        && Number(this.duijizhu.startMonth) >= 1 && Number(this.duijizhu.startMonth) <= 12 && Number(this.duijizhu.endMonth) >= 1
        && Number(this.duijizhu.endMonth) <= 12 && Number(this.duijizhu.startYear) * 12 + Number(this.duijizhu.startMonth) <= Number(this.duijizhu.endYear) * 12 + Number(this.duijizhu.endMonth)) {
        this.duijizhu.xArr = this.calculateMonths(this.duijizhu.startYear, this.duijizhu.startMonth, this.duijizhu.endYear, this.duijizhu.endMonth)
      } else {
        // 如果时间范围无效，清空数据，不设置默认的xArr
        this.duijizhu.startYear = '';
        this.duijizhu.startMonth = '';
        this.duijizhu.endYear = '';
        this.duijizhu.endMonth = '';
        this.duijizhu.xArr = [];
      }
      // console.log("this.searchType", this.searchType)
      if (this.searchType == '1') {
        await getDuijizhuType({ startYear: this.duijizhu.startYear, startMonth: this.duijizhu.startMonth, endYear: this.duijizhu.endYear, endMonth: this.duijizhu.endMonth }).then((res) => {
          if (res.data.code == 200) {
            this.duijizhu.series = []
            for (var i = 0; i < res.data.data.length; i++) {
              var emissionType = '';
              if (res.data.data[i].emissionType == 0)
                emissionType = '直接排放'
              else if (res.data.data[i].emissionType == 1)
                emissionType = '间接排放'
              else
                emissionType = '其他排放'
              var seriesobj = { //一个seriesobj即为一个物品分类1-12月的柱状图
                name: emissionType,
                type: 'bar',
                emphasis: {
                  focus: 'series'
                },
                stack: 'Ad',
                data: [],
                itemStyle: {
                  emphasis: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                  },
                  color: function () {
                    return "#" + Math.floor(Math.random() * 16777215).toString(16);
                  }
                }
              }
              for (var j = 0; j < res.data.data[i].emissionMonthAmount.length; j++) {
                var month = res.data.data[i].emissionMonthAmount[j].time
                var emissionAmount = res.data.data[i].emissionMonthAmount[j].emissionAmount
                var x = [month, emissionAmount]
                seriesobj.data.push(x)
              }
              this.duijizhu.series.push(seriesobj)
            }
          }
        })
      }
      else {
        await getDuijizhuCategory({ startYear: this.duijizhu.startYear, startMonth: this.duijizhu.startMonth, endYear: this.duijizhu.endYear, endMonth: this.duijizhu.endMonth }).then((res) => {
          if (res.data.code == 200) {
            for (var i = 0; i < res.data.data.length; i++) {
              var seriesobj = {    //一个seriesobj即为一个物品分类1-12月的柱状图
                name: res.data.data[i].objectCategory,
                type: 'bar',
                stack: 'Ad',
                data: [],
                itemStyle: {
                  emphasis: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                  },
                  color: function () {
                    return "#" + Math.floor(Math.random() * 16777215).toString(16);
                  }
                }
              }
              for (var j = 0; j < res.data.data[i].emissionMonthAmount.length; j++) {
                var month = res.data.data[i].emissionMonthAmount[j].time
                var emissionAmount = res.data.data[i].emissionMonthAmount[j].emissionAmount
                var x = [month, emissionAmount]
                seriesobj.data.push(x)
              }
              this.duijizhu.series.push(seriesobj)
            }
          }
        }).catch(() => {
        }).finally(() => {
        });
      }
      // console.log("this.duijizhu.series：",this.duijizhu.series)
      var chartDom = document.getElementById('myduijiBar');
      var myChart = echarts.init(chartDom);
      myChart.clear();
      var option;

      option = {
        title: {
          text: 'CO₂碳排放量(kg)'
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: (params) => {
            // console.log("params", params);
            let res = '碳排放量' + '<br/>'
            for (var i = 0; i < params.length; i++) {
              res += params[i].marker + params[i].seriesName + ':' + parseFloat(params[i].data[1]).toFixed(2) + '(kg)' + '<br/>'
            }
            return res;
          },
        },
        legend: {},
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: [
          {
            axisLabel: {
              margin: 10,
              interval: 0,
              rotate: 60,
            },
            type: 'category',
            data: this.duijizhu.xArr,
          }
        ],
        yAxis: [
          {
            type: 'value'
          }
        ],
        series: this.duijizhu.series,
        dataZoom: [
          {
            type: 'slider',
            show: true,
            start: 0,
            end: 70,
            height: 12,//组件高度
            // backgroundColor: '#F4F4F4',//两边未选中的滑动条区域的颜色
            realtime: true, //是否实时更新

          },
        ],
      };

      option && myChart.setOption(option, true);
    },
    //桑葚图
    getMulberry() {
      this.sangShen.data = []
      this.sangShen.links = []
      // 如果year和month为空，不传参数，让后端自动回退查找
      const params = {};
      if (this.year && this.year !== '') {
        params.year = this.year;
      }
      if (this.month && this.month !== '') {
        params.month = this.month;
      }
      getCarbonMulberry(params).then(res => {
        if (res.data.code == 200) {
          // 处理返回的数据（可能是list字段或直接是数组）
          var dataList = res.data.data.list || res.data.data;
          // 如果后端返回了actualYear，且当前year为空，则更新显示的年份（保持统一）
          // 注意：在mounted时，year已经通过getJunzhiTable统一设置了，这里主要用于用户手动查询时
          if (res.data.data.actualYear && (!this.year || this.year === '')) {
            this.year = res.data.data.actualYear;
            // 自动加载区间图：设置为该年份的1月至12月
            this.autoLoadDuijizhuForYear(res.data.data.actualYear);
          }
          // console.log("sangshen:", res.data)
          //将固定的直接手动添加进去
          var databoj1 = {
            name: '直接排放'
          }
          var databoj2 = {
            name: '间接排放'
          }
          var databoj3 = {
            name: '其他排放'
          }
          this.sangShen.data.push(databoj1)
          this.sangShen.data.push(databoj2)
          this.sangShen.data.push(databoj3)
          for (var i = 0; i < dataList.length; i++) {
            var databoj = {
              name: dataList[i].objectCategory
            }
            this.sangShen.data.push(databoj)//拿到所有物品分类
            for (var j = 0; j < dataList[i].emissionTypeAmount.length; j++) {//一个物品类别可能有多个排放类型(多个流向边)
              var emissionType = '';
              if (dataList[i].emissionTypeAmount[j].emissionType == 0)
                emissionType = '直接排放'
              else if (dataList[i].emissionTypeAmount[j].emissionType == 1)
                emissionType = '间接排放'
              else
                emissionType = '其他排放'

              var link = {//一个流向边
                source: dataList[i].objectCategory,
                target: emissionType,
                value: dataList[i].emissionTypeAmount[j].emissionAmount
              }
              this.sangShen.links.push(link);
            }
          }
          // console.log("this.sangShen.data", this.sangShen.data)
          // console.log("this.sangShen.links", this.sangShen.links)
          //开始画桑葚图
          var chartDom = document.getElementById('myMulberry');
          var myChart = echarts.init(chartDom);
          var option;
          myChart.clear();
          option = {
            title: {
              text: '',
              //   top: '-1%',
            },
            tooltip: {
              trigger: 'item',
              formatter: (params) => {
                // console.log(params);
                var name = params.name.indexOf('>') != -1 ? (params.name.split('>')[0] + '-' + params.name.split('>')[1]) : params.name
                return '碳排放量' + '<br/>' + name + ' : ' + parseFloat(params.value).toFixed(2) + '(kg)' + '<br/>';
              },
            },
            series: {
              type: 'sankey',
              layout: 'none',
              emphasis: {
                focus: 'adjacency'
              },
              data: this.sangShen.data,
              links: this.sangShen.links,
            }
          };
          option && myChart.setOption(option, true);
          window.onresize = function () {
            myChart.resize();
            //myChart1.resize();    //若有多个图表变动，可多写=
          }
        }
      })
    },
  },
}
</script>
<style scoped>
/* 标签页样式 */
.result-tabs {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

/* 标签页内容区域 */
.tab-content {
  padding: 20px 0;
}

/* 总体概览网格布局 */
.overview-grid {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 20px;
  align-items: start;
}

.overview-grid .junzhi {
  display: flex;
  justify-content: center;
}

/* 构成分析网格布局 */
.composition-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

/* 趋势对比控制区域 */
.trend-controls {
  background: var(--forest-bg-card);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid var(--forest-border-light);
}

.trend-controls .filter-form {
  display: flex;
  align-items: center;
  gap: 15px;
}

.trend-controls .filter-form .el-form-item {
  margin-bottom: 0;
}

/* Element UI 标签页样式覆盖 */
::v-deep .el-tabs__header {
  margin-bottom: 20px;
}

::v-deep .el-tabs__nav-wrap::after {
  display: none;
}

::v-deep .el-tabs__item {
  color: var(--forest-text-secondary);
  font-weight: 600;
  padding: 0 30px;
  font-size: 16px;
}

::v-deep .el-tabs__item:hover {
  color: var(--forest-primary);
}

::v-deep .el-tabs__item.is-active {
  color: var(--forest-primary);
}

::v-deep .el-tabs__active-bar {
  background-color: var(--forest-primary);
  height: 3px;
}

::v-deep .el-tabs__content {
  padding: 0;
}

.bottom {
  border-top: 0;
  /* box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04); */
}

.hr-shadow {
  margin-top: 50px;
  padding-top: 10px;
  border-left: 0;
  border-right: 0;
  border-bottom: 0;
  color: #d0d0d5;
  border-top: 10px solid rgba(0, 0, 0, .1);
  box-shadow: inset 0 10px 10px -10px;
}

.tanResult {
  width: 100%;
  background-color: var(--forest-bg-primary);
  text-align: left;
  margin: 0;
  margin-top: 10px;
  padding: 20px 20px 0 20px;
  box-sizing: border-box;
  min-height: calc(100vh - 100px);
}

.tanResult > .chooseBtn {
  max-width: 1400px;
  margin-left: auto;
  margin-right: auto;
  padding-left: 0;
  padding-right: 0;
  box-sizing: border-box;
}


.chooseBtn {
  width: 100%;
  max-width: 1400px;
  margin: 20px auto 30px;
  padding: 0;
  box-sizing: border-box;
}

.flex-box-headerr {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding-left: 20px;
  padding-right: 20px;
}

.top {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  width: 100%;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
  gap: 20px;
}

.junzhi {
  width: 370px;
  flex-shrink: 0;
}

.zhuzhuangtu {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  padding: 0;
  max-width: calc(1400px - 370px - 20px);
}

.middle {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  width: 100%;
  max-width: 1400px;
  margin: 20px auto;
  padding: 0 20px;
  gap: 20px;
  box-sizing: border-box;
}

.sangshen {
  width: 730px;
  height: 500px;
  overflow: hidden;
  flex-shrink: 0;
}

.bottom {
  width: 100%;
  margin: 0;
  padding: 20px;
  box-sizing: border-box;
  background-color: var(--forest-bg-primary);
}

.duijizhu {
  width: 100%;
  max-width: 1360px;
  height: 740px;
  overflow: hidden;
  margin: 0 auto;
}

.bingtu {
  width: 610px;
  height: 500px;
  overflow: hidden;
  flex-shrink: 0;
}
</style>
<style>
.el-input__inner {
  height: 32.5px;
}
</style>